<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OXXO | Clientes frecuentes</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/clientes.css">
</head>
<body>
  <script>
    document.addEventListener('DOMContentLoaded', () =>
      Auth.requireAuth(['CAJERO','ADMIN'])
    );
  </script>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="inicio.html" aria-label="Ir al inicio">
      <img src="../img/OXXO-Logo.wine.png" class="brand-logo" alt="OXXO" width="76">
    </a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto" id="mainNav">
        <li class="nav-item" data-roles="ADMIN,CAJERO">
          <a class="nav-link" href="inicio.html">Inicio</a>
        </li>
        <li class="nav-item" data-roles="ADMIN,CAJERO">
          <a class="nav-link" href="venta.html">Ventas</a>
        </li>
        <li class="nav-item" data-roles="ADMIN">
          <a class="nav-link" href="inventario.html">Inventario</a>
        </li>
        <li class="nav-item" data-roles="ADMIN">
          <a class="nav-link" href="productos.html">Productos</a>
        </li>
        <li class="nav-item" data-roles="ADMIN,CAJERO">
          <a class="nav-link" href="clientes.html">Clientes frecuentes</a>
        </li>
        <li class="nav-item" data-roles="ADMIN">
          <a class="nav-link" href="proveedores.html">Proveedores</a>
        </li>
        <li class="nav-item dropdown" data-roles="ADMIN">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
            Reportes
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="reportes.html#ventas">R. Ventas</a></li>
            <li><a class="dropdown-item" href="reportes.html#clientes">R. Clientes</a></li>
            <li><a class="dropdown-item" href="reportes.html#productos">R. Productos</a></li>
          </ul>
        </li>
        <li class="nav-item" data-roles="ADMIN,CAJERO">
          <a class="nav-link" href="cierre.html">Cierre de caja</a>
        </li>
      </ul>

      <div class="d-flex align-items-center gap-2">
        <span class="navbar-text small">Hola, <strong id="navUserName">â€”</strong></span>
        <a class="btn btn-outline-light btn-sm" href="cierre.html" data-roles="ADMIN,CAJERO">Cerrar turno</a>
        <button class="btn btn-outline-light btn-sm" type="button" onclick="Auth.logout()">Salir</button>
      </div>
    </div>
  </div>
</nav>

<main class="container-fluid">
  <div class="row">
    <div class="col-12 col-xxl-10 mx-auto px-3 px-md-4">
      <div class="pt-3 pb-2 border-bottom d-flex justify-content-between align-items-center">
        <h1 class="h4 fw-bold text-danger m-0">ðŸ‘¥ Clientes frecuentes</h1>
        <div class="d-flex gap-2">
          <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalCli" onclick="openCli()">Nuevo</button>
          <button class="btn btn-outline-secondary" id="btnExport">Exportar CSV</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="row g-3 mt-2">
        <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <h6 class="text-muted m-0">Clientes</h6><span id="kpiClientes">0</span>
        </div></div></div>
        <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <h6 class="text-muted m-0">Con compras</h6><span id="kpiConCompras">0</span>
        </div></div></div>
        <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <h6 class="text-muted m-0">Puntos totales</h6><span id="kpiPuntosTotales">0</span>
        </div></div></div>
        <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
          <h6 class="text-muted m-0">Ticket prom. (hist)</h6><span id="kpiTicketProm">$0.00</span>
        </div></div></div>
      </div>

      <!-- Filtros -->
      <div class="d-flex flex-wrap gap-2 my-3">
        <input id="filtroTxt" class="form-control form-control-sm w-auto" placeholder="Buscar DNI / nombre / telÃ©fono">
        <select id="filtroOrden" class="form-select form-select-sm w-auto">
          <option value="nombre">Nombre Aâ†’Z</option>
          <option value="puntos">Puntos â†“</option>
          <option value="compras">Compras â†“</option>
          <option value="recientes">MÃ¡s recientes</option>
        </select>
      </div>

      <!-- Tabla -->
      <div class="table-responsive" style="max-height:520px;">
        <table class="table table-hover align-middle" id="tbCli">
          <thead class="table-dark">
            <tr>
              <th>DNI/Doc</th><th>Nombre</th><th>TelÃ©fono</th><th>Email</th>
              <th class="text-end">Compras</th><th class="text-end">Puntos</th><th>Ãšltima compra</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="cliBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Modal cliente -->
<div class="modal fade" id="modalCli" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title" id="titleCli">Nuevo cliente</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="formCli" class="needs-validation" novalidate>
        <input type="hidden" id="editDoc">
        <div class="mb-2">
          <label class="form-label">DNI/Documento</label>
          <input id="cDoc" class="form-control" required>
          <div class="invalid-feedback">Requerido.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input id="cNom" class="form-control" required>
          <div class="invalid-feedback">Requerido.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">TelÃ©fono</label>
          <input id="cTel" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input id="cMail" type="email" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Puntos</label>
          <input id="cPts" type="number" min="0" class="form-control" value="0">
        </div>
        <button class="btn btn-danger w-100">Guardar</button>
      </form>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auth.js" defer></script>
<script src="/js/api.js"  defer></script>

<script>
  'use strict';

  const $ = s => document.querySelector(s);
  const parseNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
  const fmtMoney = n =>
    new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' })
      .format(Number(n || 0));

  // Array que viene de la BD
  let CLIENTES = [];

  /* --------- Cargar KPIs desde la BD --------- */
  async function loadKpis() {
    try {
      const r = await fetch('/api/clientes/kpis');
      if (!r.ok) throw new Error('KPIs');
      const k = await r.json();
      document.getElementById('kpiClientes').textContent      = k.clientes ?? 0;
      document.getElementById('kpiConCompras').textContent    = k.conCompras ?? 0;
      document.getElementById('kpiPuntosTotales').textContent = k.puntosTotales ?? 0;
      document.getElementById('kpiTicketProm').textContent    = fmtMoney(k.ticketPromHist ?? 0);
    } catch (err) {
      console.warn('Error KPIs clientes:', err);
    }
  }

  /* --------- Cargar clientes desde la BD --------- */
  async function loadClientes() {
    try {
      const r = await fetch('/api/clientes');
      if (!r.ok) throw new Error('Lista clientes');
      CLIENTES = await r.json();
      renderClientes();
    } catch (err) {
      console.error('Error cargando clientes:', err);
      CLIENTES = [];
      renderClientes();
    }
  }

  function renderClientes() {
  const tbody = document.getElementById('cliBody');
  tbody.innerHTML = '';

  const q   = ($('#filtroTxt').value || '').toLowerCase();
  const ord = $('#filtroOrden').value || 'nombre';

  let data = CLIENTES.slice();

  if (q) {
    data = data.filter(c =>
      (c.doc || '').toLowerCase().includes(q) ||
      (c.nombre || '').toLowerCase().includes(q) ||
      (c.telefono || '').toLowerCase().includes(q)
    );
  }

  if (ord === 'nombre') {
    data.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
  } else if (ord === 'puntos') {
    data.sort((a, b) => (b.puntos || 0) - (a.puntos || 0));
  } else if (ord === 'compras') {
    data.sort((a, b) => (b.compras || 0) - (a.compras || 0));
  } else if (ord === 'recientes') {
    data.sort((a, b) =>
      (b.ultimaCompra || '').localeCompare(a.ultimaCompra || '')
    );
  }

  for (const c of data) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.doc ?? ''}</td>
      <td>${c.nombre ?? '-'}</td>
      <td>${c.telefono ?? '-'}</td>
      <td>${c.email ?? '-'}</td>
      <td class="text-end">${c.compras ?? 0}</td>
      <td class="text-end">${c.puntos ?? 0}</td>
      <td>${c.ultimaCompra ? new Date(c.ultimaCompra).toLocaleString() : 'â€”'}</td>
      <td class="text-end">
        <button
          class="btn btn-sm btn-outline-primary me-1"
          data-bs-toggle="modal"
          data-bs-target="#modalCli"
          onclick="openCli('${c.doc}')">
          Editar
        </button>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="sumarPuntos('${c.doc}',5)">+5 pts</button>
        <button class="btn btn-sm btn-outline-danger" onclick="eliminarCliente('${c.doc}')">Eliminar</button>
      </td>`;
    tbody.appendChild(tr);
  }
}


  /* --------- Modal: nuevo / editar cliente --------- */
  function openCli(doc) {
    const form = document.getElementById('formCli');
    form.reset();
    form.classList.remove('was-validated');
    document.getElementById('editDoc').value = '';
    const inpDoc = document.getElementById('cDoc');
    inpDoc.disabled = false;

    if (doc) {
      const c = CLIENTES.find(x => x.doc === doc);
      if (!c) return;
      document.getElementById('titleCli').textContent = 'Editar cliente';
      document.getElementById('editDoc').value = c.doc;
      inpDoc.value = c.doc;
      inpDoc.disabled = true;
      document.getElementById('cNom').value  = c.nombre  || '';
      document.getElementById('cTel').value  = c.telefono || '';
      document.getElementById('cMail').value = c.email || '';
      document.getElementById('cPts').value  = c.puntos ?? 0;
    } else {
      document.getElementById('titleCli').textContent = 'Nuevo cliente';
      document.getElementById('cPts').value = 0;
    }
  }

  window.openCli = openCli; // para usar en onclick

  document.getElementById('formCli').addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.currentTarget;
    if (!f.checkValidity()) {
      f.classList.add('was-validated');
      return;
    }

    const edit = document.getElementById('editDoc').value;
    const body = {
      doc:      document.getElementById('cDoc').value.trim(),
      nombre:   document.getElementById('cNom').value.trim(),
      telefono: document.getElementById('cTel').value.trim() || null,
      email:    document.getElementById('cMail').value.trim() || null,
      puntos:   parseNum(document.getElementById('cPts').value) || 0
    };

    try {
      let url = '/api/clientes';
      let method = 'POST';
      if (edit) {
        url = `/api/clientes/${encodeURIComponent(edit)}`;
        method = 'PUT';
        body.doc = edit; // doc no cambia
      }
      const r = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        const txt = await r.text().catch(() => '');
        throw new Error(txt || r.statusText);
      }

      // cerrar modal y recargar datos
      const modalEl = document.getElementById('modalCli');
      const modal   = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();

      await loadClientes();
      await loadKpis();
    } catch (err) {
      alert('Error al guardar cliente: ' + (err.message || err));
    }
  });

  /* --------- Sumar puntos por compras (relaciÃ³n con ventas) --------- */
  async function sumarPuntos(doc, pts) {
    try {
      const url = `/api/clientes/${encodeURIComponent(doc)}/compra?puntos=${encodeURIComponent(pts)}`;
      const r = await fetch(url, { method: 'POST' });
      if (!r.ok) throw new Error('Error al sumar puntos');
      await loadClientes();
      await loadKpis();
    } catch (err) {
      alert('No se pudo actualizar puntos: ' + (err.message || err));
    }
  }
  window.sumarPuntos = sumarPuntos;

  /* --------- Eliminar cliente --------- */
  async function eliminarCliente(doc) {
    if (!confirm('Â¿Eliminar cliente ' + doc + '?')) return;
    try {
      const url = `/api/clientes/${encodeURIComponent(doc)}`;
      const r = await fetch(url, { method: 'DELETE' });
      if (!r.ok) throw new Error('Error al eliminar');
      await loadClientes();
      await loadKpis();
    } catch (err) {
      alert('No se pudo eliminar: ' + (err.message || err));
    }
  }
  window.eliminarCliente = eliminarCliente;

  /* --------- Exportar CSV desde datos de BD --------- */
  document.getElementById('btnExport').addEventListener('click', () => {
    const rows = [['doc', 'nombre', 'telefono', 'email', 'compras', 'puntos', 'ultimaCompra']];
    CLIENTES.forEach(c => {
      rows.push([
        c.doc ?? '',
        c.nombre ?? '',
        c.telefono ?? '',
        c.email ?? '',
        c.compras ?? 0,
        c.puntos ?? 0,
        c.ultimaCompra ?? ''
      ]);
    });
    const csv = rows
      .map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(','))
      .join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'clientes.csv';
    a.click();
  });

  /* --------- Filtros --------- */
  document.getElementById('filtroTxt').addEventListener('input', renderClientes);
  document.getElementById('filtroOrden').addEventListener('change', renderClientes);

  /* --------- Marcar nav activo --------- */
  (function markActive() {
    const f = location.pathname.split('/').pop() || 'clientes.html';
    document.querySelectorAll('.navbar-nav .nav-link').forEach(a => {
      if (a.getAttribute('href') === f) a.classList.add('active');
    });
  })();

  /* --------- Init --------- */
  (async () => {
    await loadKpis();
    await loadClientes();
  })();
</script>
</body>
</html>
