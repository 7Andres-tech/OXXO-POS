<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OXXO | Iniciar sesión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root{ --oxxo-red:#cc0000; --bg-app:#fff5e1; }
    html,body{ background:var(--bg-app); }
    .auth-wrap{ min-height:100vh; display:grid; place-items:center; padding:24px; }
    .auth-frame{ display:flex; gap:32px; justify-content:center; align-items:stretch; width:100%; }
    .auth-card{
      width:440px; max-width:100%;
      border:0; border-radius:20px; background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      display:flex; flex-direction:column;
    }
    .auth-header{ text-align:center; padding:28px 32px 8px; }
    .brand-logo{ height:40px; width:auto; display:block; margin:0 auto 10px; }
    .auth-content{ max-width:460px; width:100%; margin:0 auto; padding:8px 16px 24px; }
    .btn-oxxo{ background:var(--oxxo-red); border-color:var(--oxxo-red); }
    .btn-oxxo:hover{ filter:brightness(.95); }
    .btn-eye{ position:absolute; right:.75rem; top:50%; transform:translateY(-50%); color:#6c757d; }
    .auth-hero{
      width:700px; max-width:100%;
      border-radius:20px; overflow:hidden; background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .auth-hero img{ display:block; width:100%; height:100%; object-fit:cover; }
    .form-floating > .form-control:not(:placeholder-shown) ~ label,
    .form-floating > .form-control:-webkit-autofill ~ label{
      opacity:.65; transform: scale(.85) translateY(-0.5rem) translateX(.15rem);
    }
    @media (max-width: 992px){
      .auth-frame{ flex-direction:column; }
      .auth-hero{ height:260px; }
    }
  </style>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-frame">

      <!-- IZQUIERDA: LOGIN -->
      <div class="auth-card">
        <div class="auth-header">
          <img src="/img/OXXO-Logo.wine.png" alt="OXXO" class="brand-logo">
          <p class="text-muted mb-3">Inicia sesión</p>
        </div>

        <div class="auth-content">
          <form id="formLogin" class="needs-validation" novalidate>
            <div class="form-floating mb-3">
              <input type="email" class="form-control" id="email" placeholder=" " required autocomplete="email">
              <label for="email"><i class="bi bi-envelope me-1"></i> Correo electrónico</label>
              <div class="invalid-feedback">Ingresa un correo válido.</div>
            </div>

            <div class="position-relative">
              <div class="form-floating mb-2">
                <input type="password" class="form-control pe-5" id="pass" placeholder=" " required minlength="4" autocomplete="current-password">
                <label for="pass"><i class="bi bi-lock me-1"></i> Contraseña</label>
              </div>
              <button type="button" class="btn btn-link btn-sm btn-eye" id="btnShow" tabindex="-1" aria-label="Mostrar/Ocultar">
                <i class="bi bi-eye-slash"></i>
              </button>
              <div class="invalid-feedback">Mínimo 4 caracteres.</div>
            </div>

            <div class="d-flex justify-content-center align-items-center gap-3 my-3">
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="remember" checked>
                <label class="form-check-label" for="remember">Recordarme</label>
              </div>
             
            </div>

            <button class="btn btn-oxxo btn-lg w-100" type="submit">INGRESAR</button>

            

           
            <p class="text-center text-muted small mt-2 mb-0">© 2025 OXXO • v1.0</p>
          </form>
        </div>
      </div>

      <!-- DERECHA: IMAGEN MISMO TAMAÑO -->
      <div class="auth-hero">
        <img src="/img/tienda.png" alt="Tienda OXXO">
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <!-- importa auth.js -->
<script src="js/auth.js" defer></script>
<script src="/js/api.js"  defer></script>
<script>
  (function () {
    const $ = (id) => document.getElementById(id);
  
    // Mostrar/Ocultar pass
    const passEl = $('pass'), btnShow = $('btnShow');
    btnShow?.addEventListener('click', () => {
      const t = passEl.type === 'password' ? 'text' : 'password';
      passEl.type = t;
      btnShow.firstElementChild.className = (t === 'password') ? 'bi bi-eye-slash' : 'bi bi-eye';
      passEl.focus();
    });
  
    // recordar email
    const remembered = localStorage.getItem('remember_email');
    if (remembered) $('email').value = remembered;
  
    function decideRedirect(role){
      window.location.href = (String(role||'').toUpperCase() === 'CAJERO') ? 'venta.html' : 'inicio.html';
    }
  
    $('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.currentTarget;
      if (!f.checkValidity()) { f.classList.add('was-validated'); return; }
  
      const email = $('email').value.trim();
      const password = $('pass').value;
      const remember = $('remember')?.checked;
  
      try {
        const r = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }); 
        if (!r.ok) {
          const msg = (await r.json().catch(()=>({}))).message || (r.status === 401 ? 'Credenciales inválidas' : 'Error al iniciar sesión');
          throw new Error(msg);
        }
  
        const auth = await r.json(); // {email,name,role,token}
        localStorage.setItem('auth', JSON.stringify(auth));
        localStorage.setItem('session_user', auth.email);
        localStorage.setItem('session_login_at', new Date().toISOString());
        localStorage.setItem('cajeroNombre', auth.name || (auth.email||'').split('@')[0] || 'Cajero 01');
        if (remember) localStorage.setItem('remember_email', email); else localStorage.removeItem('remember_email');
  
        decideRedirect(auth.role);
      } catch (err) {
        alert(err.message || 'No se pudo iniciar sesión');
      }
    });
  })();
  </script>
  


</body>
</html>
