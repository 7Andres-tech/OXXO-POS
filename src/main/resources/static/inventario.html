<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OXXO | Inventario (CRUD + Autocomplete)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/inventario.css">
  <link rel="icon" href="/img/favicon.ico">
</head>
<body>
  <script> document.addEventListener('DOMContentLoaded', () => Auth.requireAuth(['ADMIN'])); </script>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="inicio.html" aria-label="Ir al inicio">
      <img src="/img/OXXO-Logo.wine.png" class="brand-logo" alt="OXXO" width="76">
    </a>

    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="inicio.html">Inicio</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="venta.html">Ventas</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="clientes.html">Clientes frecuentes</a></li>

        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="inventario.html">Inventario</a></li>
        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="productos.html">Productos</a></li>
        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="proveedores.html">Proveedores</a></li>

        <li class="nav-item dropdown" data-roles="ADMIN">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Reportes</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="reportes.html#ventas">R. Ventas</a></li>
            <li><a class="dropdown-item" href="reportes.html#clientes">R. Inventario</a></li>
            <li><a class="dropdown-item" href="reportes.html#productos">R. Productos</a></li>
          </ul>
        </li>

        <li class="nav-item" data-roles="ADMIN"><a class="nav-link active" href="usuarios.html">G. Usuarios</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="cierre.html">Cierre de caja</a></li>
      </ul>

      <div class="d-flex align-items-center gap-2">
        <span class="navbar-text small">Hola, <strong id="navUserName">‚Äî</strong></span>
        <a class="btn btn-outline-light btn-sm" href="cierre.html" data-roles="ADMIN,CAJERO">Cerrar turno</a>
        <button class="btn btn-outline-light btn-sm" type="button" onclick="Auth.logout()">Salir</button>
      </div>
    </div>
  </div>
</nav>


<!-- CONTENT -->
<main class="container-fluid with-sidebar">
  <div class="row">
    <div class="col-12 px-3 px-md-4">

      <div class="pt-3 pb-2 border-bottom d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <h1 class="h4 fw-bold text-danger m-0">üì¶ Inventario</h1>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-outline-secondary" href="productos.html">Gestionar productos</a>
          <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalItem" onclick="openItem()">Nuevo item</button>
          <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAjuste">Ajuste r√°pido</button>
          <button class="btn btn-outline-secondary" id="btnExportTop">Exportar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="row g-3 mt-2">
        <div class="col-6 col-md-3">
          <div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">SKUs activos</h6>
            <div class="fs-3 fw-semibold"><span id="kpiSkus">0</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Stock total</h6>
            <div class="fs-3 fw-semibold"><span id="kpiStockTotal">0</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Stock bajo</h6>
            <div class="fs-3 fw-semibold text-danger"><span id="kpiStockBajo">0</span></div>
          </div></div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Sin stock</h6>
            <div class="fs-3 fw-semibold"><span id="kpiSinStock">0</span></div>
          </div></div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="d-flex flex-wrap align-items-center gap-2 my-3">
        <input id="filtroTxt" class="form-control form-control-sm w-auto" placeholder="Buscar SKU / nombre">
        <select id="filtroCat" class="form-select form-select-sm w-auto">
          <option value="">Todas las categor√≠as</option>
        </select>
        <select id="filtroProv" class="form-select form-select-sm w-auto">
          <option value="">Todos los proveedores</option>
        </select>
        <select id="filtroEstado" class="form-select form-select-sm w-auto">
          <option value="">Todos</option>
          <option value="ok">OK</option>
          <option value="bajo">Stock bajo</option>
          <option value="cero">Sin stock</option>
        </select>
        <button class="btn btn-sm btn-outline-secondary" id="btnExport">Exportar</button>
      </div>

      <!-- Tabla -->
      <div class="table-responsive" style="max-height:480px;">
        <table class="table table-hover align-middle" id="tablaInv">
          <thead class="table-dark">
            <tr>
              <th>SKU</th><th>Producto</th><th>Categor√≠a</th>
              <th class="text-end">Stock</th><th class="text-end">M√≠nimo</th>
              <th>Proveedor</th><th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>

    </div>
  </div>
</main>

<!-- MODAL: Crear/Editar item -->
<div class="modal fade" id="modalItem" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title" id="titleItem">Nuevo item</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="formItem" class="row g-2 needs-validation" novalidate>
        <input type="hidden" id="editSku" value="">
        <div class="col-6">
          <label class="form-label">SKU</label>
          <input id="itSku" class="form-control" required>
          <div class="invalid-feedback">SKU requerido (√∫nico).</div>
        </div>
       
        <div class="col-12">
          <label class="form-label">Nombre (solo referencia)</label>
          <input id="itNombre" class="form-control">
        </div>
        <div class="col-6">
          <label class="form-label">Categor√≠a (solo referencia)</label>
          <input id="itCat" class="form-control">
        </div>
        <div class="col-6">
          <label class="form-label">Proveedor (solo referencia)</label>
          <input id="itProv" class="form-control">
        </div>
        <div class="col-6">
          <label class="form-label">Stock inicial</label>
          <input id="itStock" type="number" min="0" class="form-control" value="0" required>
          <div class="invalid-feedback">Ingresa stock ‚â• 0.</div>
        </div>
        <div class="col-6">
          <label class="form-label">Stock m√≠nimo</label>
          <input id="itMin" type="number" min="0" class="form-control" value="0" required>
          <div class="invalid-feedback">Ingresa m√≠nimo ‚â• 0.</div>
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-danger">Guardar</button>
        </div>
      </form>
    </div>
  </div></div>
</div>

<!-- MODAL AJUSTE (con autocomplete) -->
<div class="modal fade" id="modalAjuste" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-warning">
      <h5 class="modal-title">Ajuste de stock</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="formAjuste" class="needs-validation" novalidate>
        <div class="mb-2">
          <label class="form-label">Producto (SKU o nombre)</label>
          <input id="ajProd" class="form-control" placeholder="SNACK-01" autocomplete="off" required>
          <div class="invalid-feedback">Selecciona un producto.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">Cantidad (+ ingreso / - salida)</label>
          <input id="ajCant" type="number" class="form-control" required>
          <div class="invalid-feedback">Ingresa una cantidad.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">Motivo</label>
          <select id="ajMotivo" class="form-select" required>
            <option value="">Elegir‚Ä¶</option>
            <option>Conteo c√≠clico</option>
            <option>Merma</option>
            <option>Caducidad</option>
            <option>Correcci√≥n</option>
          </select>
          <div class="invalid-feedback">Selecciona motivo.</div>
        </div>
        <button class="btn btn-warning w-100">Aplicar ajuste</button>
      </form>
    </div>
  </div></div>
</div>

<!-- MODAL MOVIMIENTOS (opcional, sin backend por ahora) -->
<div class="modal fade" id="modalMov" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-light">
      <h5 class="modal-title">Movimientos de inventario</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <table class="table table-sm">
        <thead class="table-light">
          <tr><th>Fecha</th><th>SKU</th><th>Producto</th><th>Cant.</th><th>Motivo</th></tr>
        </thead>
        <tbody id="tbMov"></tbody>
      </table>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<!-- Cargar API primero -->
<script src="/js/auth.js" defer></script>
<script src="/js/api.js"  defer></script>

<script defer>
(() => {
  'use strict';

  const $ = id => document.getElementById(id);

  /* =================== Helpers de red (igual que productos) =================== */
  function authHeaders() {
    const h = (window.Auth && typeof Auth.authHeader === 'function') ? Auth.authHeader() : {};
    return { 'Content-Type': 'application/json', ...h };
  }

  function isAuthError(res) { return res.status === 401 || res.status === 403; }

  async function fetchJSON(url, opts = {}) {
    const r = await fetch(url, { headers: authHeaders(), ...opts });
    if (isAuthError(r)) {
      alert('Sesi√≥n expirada o sin permisos. Vuelve a iniciar sesi√≥n.');
      if (window.Auth?.clear) Auth.clear();
      location.href = 'index.html';
      throw new Error('unauthorized');
    }
    if (!r.ok) {
      const msg = (await r.text().catch(() => '')) || r.statusText;
      throw new Error(msg);
    }
    if (r.status === 204) return null;
    return r.json();
  }

  /* =================== API Inventario (backend real) =================== */
  async function apiListInventario() {
    return fetchJSON('/api/inventario');
  }

  // AjusteRequest: { sku, tipo, cantidad, motivo, minimo?, vence? }
  async function apiAjuste(payload) {
    return fetchJSON('/api/inventario/ajustes', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
  }

  /* =================== Normalizaci√≥n y estado =================== */
  function norm(i) {
    return {
      sku:       i.sku || '',
      nombre:    i.nombre || '',
      categoria: i.categoria || '',
      proveedor: i.proveedor || '',
      stock:     Number(i.stock ?? 0),
      minimo:    Number(i.minimo ?? 0),
     
    };
  }

  function estadoItem(it) {
    if (it.stock <= 0) return { code: 'cero',  text: 'Sin stock', badge: 'secondary' };
    if (it.stock < it.minimo) return { code: 'bajo', text: 'Stock bajo', badge: 'warning' };
    return { code: 'ok', text: 'OK', badge: 'success' };
  }

  let DATA = [];
  let modalItem  = null;
  let modalAjuste = null;

  /* =================== KPIs =================== */
  function renderKPIs(list) {
    const arr = list.map(norm);
    const skus  = arr.length;
    const total = arr.reduce((s, i) => s + (Number.isFinite(i.stock) ? i.stock : 0), 0);
    const bajo  = arr.filter(i => estadoItem(i).code === 'bajo').length;
    const cero  = arr.filter(i => estadoItem(i).code === 'cero').length;

    setText('kpiSkus', skus);
    setText('kpiStockTotal', total);
    setText('kpiStockBajo', bajo);
    setText('kpiSinStock', cero);
  }

  /* =================== Filtros y tabla =================== */
  function fillFilters(list) {
    const arr = list.map(norm);
    const cats = Array.from(new Set(arr.map(i => i.categoria).filter(Boolean))).sort();
    const provs = Array.from(new Set(arr.map(i => i.proveedor).filter(Boolean))).sort();

    const selCat  = $('filtroCat');
    const selProv = $('filtroProv');

    selCat.innerHTML  = '<option value="">Todas las categor√≠as</option>' +
      cats.map(c => `<option value="${c}">${c}</option>`).join('');

    selProv.innerHTML = '<option value="">Todos los proveedores</option>' +
      provs.map(p => `<option value="${p}">${p}</option>`).join('');
  }

  function applyFilters() {
    const txt  = ($('filtroTxt').value || '').trim().toLowerCase();
    const cat  = $('filtroCat').value || '';
    const prov = $('filtroProv').value || '';
    const est  = $('filtroEstado').value || '';

    let arr = DATA.map(norm).filter(it => {
      let ok = true;
      if (txt) {
        ok = ok && (
          (it.sku || '').toLowerCase().includes(txt) ||
          (it.nombre || '').toLowerCase().includes(txt)
        );
      }
      if (cat)  ok = ok && it.categoria === cat;
      if (prov) ok = ok && it.proveedor === prov;
      if (est)  ok = ok && estadoItem(it).code === est;
      return ok;
    });

    renderTabla(arr);
  }

  function fmtDate(d) {
    if (!d) return '-';
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return d;
    return dt.toISOString().slice(0, 10);
  }

  function renderTabla(list) {
    const tb = $('invBody');
    tb.innerHTML = '';

    if (!list.length) {
      tb.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Sin datos</td></tr>';
      return;
    }

    for (const it of list) {
      const est = estadoItem(it);
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${it.sku}</td>
          <td>${it.nombre || '-'}</td>
          <td>${it.categoria || '-'}</td>
          <td class="text-end">${it.stock}</td>
          <td class="text-end">${it.minimo}</td>
          <td>${it.proveedor || '-'}</td>
          
          <td><span class="badge bg-${est.badge}">${est.text}</span></td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="openAjusteSku('${it.sku}')">Ajustar</button>
            </div>
          </td>
        </tr>
      `);
    }
  }

  /* =================== Acciones globales =================== */

  function setText(id, v) { const el = $(id); if (el) el.textContent = v; }

  window.openItem = () => {
    const form = $('formItem');
    if (!form) return;
    form.reset();
    form.classList.remove('was-validated');
    $('editSku').value = '';
    $('titleItem').textContent = 'Nuevo item';
    if (modalItem) modalItem.show();
  };

  window.openAjusteSku = (sku) => {
    const f = $('formAjuste');
    if (!f) return;
    f.reset();
    f.classList.remove('was-validated');
    $('ajProd').value = sku;
    if (modalAjuste) modalAjuste.show();
  };

  function setupFilters() {
    ['filtroTxt','filtroCat','filtroProv','filtroEstado'].forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('input', applyFilters);
      el.addEventListener('change', applyFilters);
    });
  }

  function setupFormItem() {
    const form = $('formItem');
    if (!form) return;

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();

      form.classList.add('was-validated');
      if (!form.checkValidity()) return;

      const sku   = $('itSku').value.trim();
      const stock = Number($('itStock').value || 0);
      const min   = Number($('itMin').value || 0);
      

      // Tomamos nombre/categor√≠a/proveedor solo como referencia (el backend los puede ignorar)
      const payload = {
        sku,
        tipo: 'INGRESO',
        cantidad: stock,
        motivo: 'Alta manual',
        minimo: min,
       
      };

      try {
        await apiAjuste(payload);
        if (modalItem) modalItem.hide();
        form.reset();
        form.classList.remove('was-validated');
        await initInv();
      } catch (e) {
        alert('Error al guardar item: ' + (e.message || e));
      }
    });
  }

  function setupFormAjuste() {
    const form = $('formAjuste');
    if (!form) return;

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();

      form.classList.add('was-validated');
      if (!form.checkValidity()) return;

      let sku = $('ajProd').value.trim();
      if (!sku) return;

      let cant = Number($('ajCant').value);
      const motivo = $('ajMotivo').value;

      if (!Number.isFinite(cant) || cant === 0) {
        alert('La cantidad debe ser distinta de 0.');
        return;
      }

      const tipo = cant > 0 ? 'INGRESO' : 'SALIDA';
      cant = Math.abs(cant);

      const payload = { sku, tipo, cantidad: cant, motivo };

      try {
        await apiAjuste(payload);
        if (modalAjuste) modalAjuste.hide();
        form.reset();
        form.classList.remove('was-validated');
        await initInv();
      } catch (e) {
        alert('Error al aplicar ajuste: ' + (e.message || e));
      }
    });
  }

  /* =================== Init =================== */
  async function initInv() {
    try {
      const raw = await apiListInventario();
      const arr = Array.isArray(raw) ? raw : [];
      DATA = arr;
      renderKPIs(DATA);
      fillFilters(DATA);
      applyFilters();
    } catch (e) {
      console.error('Error cargando inventario:', e);
      $('invBody').innerHTML = `<tr><td colspan="9" class="text-danger">Error: ${e.message || e}</td></tr>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (window.bootstrap) {
      if ($('modalItem'))  modalItem  = new bootstrap.Modal($('modalItem'));
      if ($('modalAjuste')) modalAjuste = new bootstrap.Modal($('modalAjuste'));
    }
    setupFilters();
    setupFormItem();
    setupFormAjuste();
    initInv();
  });

})();
</script>

</body>
</html>
