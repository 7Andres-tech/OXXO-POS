<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OXXO | Productos (CatÃ¡logo CRUD)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/productos.css">
  <link rel="icon" href="/img/favicon.ico">
</head>
<body>
  <script> document.addEventListener('DOMContentLoaded', () => Auth.requireAuth(['ADMIN'])); </script>
<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="inicio.html" aria-label="Ir al inicio">
      <img src="/img/OXXO-Logo.wine.png" class="brand-logo" alt="OXXO" width="76">
    </a>

    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="inicio.html">Inicio</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="venta.html">Ventas</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="clientes.html">Clientes frecuentes</a></li>

        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="inventario.html">Inventario</a></li>
        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="productos.html">Productos</a></li>
        <li class="nav-item" data-roles="ADMIN"><a class="nav-link" href="proveedores.html">Proveedores</a></li>

        <li class="nav-item dropdown" data-roles="ADMIN">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Reportes</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="reportes.html#ventas">R. Ventas</a></li>
            <li><a class="dropdown-item" href="reportes.html#clientes">R. Inventario</a></li>
            <li><a class="dropdown-item" href="reportes.html#productos">R. Productos</a></li>
          </ul>
        </li>

        <li class="nav-item" data-roles="ADMIN"><a class="nav-link active" href="usuarios.html">G. Usuarios</a></li>
        <li class="nav-item" data-roles="ADMIN,CAJERO"><a class="nav-link" href="cierre.html">Cierre de caja</a></li>
      </ul>

      <div class="d-flex align-items-center gap-2">
        <span class="navbar-text small">Hola, <strong id="navUserName">â€”</strong></span>
        <a class="btn btn-outline-light btn-sm" href="cierre.html" data-roles="ADMIN,CAJERO">Cerrar turno</a>
        <button class="btn btn-outline-light btn-sm" type="button" onclick="Auth.logout()">Salir</button>
      </div>
    </div>
  </div>
</nav>

  <!-- CONTENT -->
  <main class="container-fluid with-sidebar">
    <div class="row">
      <div class="col-12 px-3 px-md-4">

        <div class="pt-3 pb-2 border-bottom d-flex flex-wrap gap-2 justify-content-between align-items-center">
          <h1 class="h4 fw-bold text-danger m-0">ðŸ§º Productos (CatÃ¡logo)</h1>
          <div class="d-flex flex-wrap gap-2">
            <!-- NUEVO / EDITAR usa openProd() -->
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalProd" onclick="openProd()">Nuevo producto</button>
            <button class="btn btn-outline-secondary" id="btnExport">Exportar CSV</button>
            <button class="btn btn-outline-primary" id="btnImport">Importar CSV</button>
            <button class="btn btn-outline-dark" id="btnPlantilla">Plantilla CSV</button>
            <input type="file" id="csvInput" accept=".csv" hidden>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mt-2">
          <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Productos totales</h6><div class="fs-3 fw-semibold" id="kpiTot">â€”</div>
          </div></div></div>
          <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Activos</h6><div class="fs-3 fw-semibold" id="kpiAct">â€”</div>
          </div></div></div>
          <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">CategorÃ­as</h6><div class="fs-3 fw-semibold" id="kpiCat">â€”</div>
          </div></div></div>
          <div class="col-6 col-md-3"><div class="card shadow-sm"><div class="card-body">
            <h6 class="text-muted m-0">Precio prom.</h6><div class="fs-3 fw-semibold" id="kpiProm">â€”</div>
          </div></div></div>
        </div>

        <!-- Filtros -->
        <div class="d-flex flex-wrap align-items-center gap-2 my-3">
          <input id="filtroTxt" class="form-control form-control-sm w-auto" placeholder="Buscar SKU / nombre / cÃ³digo barras">
          <select id="filtroCat" class="form-select form-select-sm w-auto"></select>
          <select id="filtroProv" class="form-select form-select-sm w-auto"></select>
          <select id="filtroEstado" class="form-select form-select-sm w-auto">
            <option value="">Todos</option>
            <option value="act">Activos</option>
            <option value="ina">Inactivos</option>
          </select>
          <select id="filtroOrden" class="form-select form-select-sm w-auto">
            <option value="nombreAsc">Orden: Nombre Aâ†’Z</option>
            <option value="precioDesc">Precio â†“</option>
            <option value="margenDesc">Margen % â†“</option>
          </select>
        </div>

        <!-- Tabla -->
        <div class="table-responsive" style="max-height:480px;">
          <table class="table" id="tablaProd">
            <thead class="table-dark">
              <tr>
                <th>SKU</th><th>Producto</th><th>CÃ³digo barras</th><th>CategorÃ­a</th><th>Proveedor</th>
                <th class="text-end">Precio</th><th class="text-end">Costo</th><th class="text-end">Margen</th>
                <th>Estado</th><th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="prodBody"></tbody>
          </table>
        </div>

      </div>
    </div>
  </main>

  <!-- MODAL: Crear/Editar producto -->
  <div class="modal fade" id="modalProd" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="titleProd">Nuevo producto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formProd" class="row g-2 needs-validation" novalidate>
          <input type="hidden" id="editSku" value="">
          <div class="col-6">
            <label class="form-label">SKU</label>
            <input id="pSku" class="form-control" required>
            <div class="invalid-feedback">SKU requerido (Ãºnico).</div>
          </div>
          <div class="col-6">
            <label class="form-label">CÃ³digo de barras</label>
            <input id="pBar" class="form-control" placeholder="EAN/UPC">
          </div>
          <div class="col-12">
            <label class="form-label">Nombre</label>
            <input id="pNom" class="form-control" required>
            <div class="invalid-feedback">Nombre requerido.</div>
          </div>
          <div class="col-6">
            <label class="form-label">CategorÃ­a</label>
            <input id="pCat" list="dlCat" class="form-control" required>
            <datalist id="dlCat"></datalist>
            <div class="invalid-feedback">CategorÃ­a requerida.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Proveedor</label>
            <input id="pProv" list="dlProv" class="form-control" required>
            <datalist id="dlProv"></datalist>
            <div class="invalid-feedback">Proveedor requerido.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Precio</label>
            <input id="pPrecio" type="number" min="0" step="0.01" class="form-control" required>
            <div class="invalid-feedback">Precio â‰¥ 0.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Costo</label>
            <input id="pCosto" type="number" min="0" step="0.01" class="form-control" required>
            <div class="invalid-feedback">Costo â‰¥ 0.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Unidad</label>
            <input id="pUnidad" class="form-control" placeholder="p.ej. botella, bolsa">
          </div>
          <div class="col-6">
            <label class="form-label">Estado</label>
            <select id="pActivo" class="form-select">
              <option value="true" selected>Activo</option>
              <option value="false">Inactivo</option>
            </select>
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-danger">Guardar</button>
          </div>
        </form>
      </div>
    </div></div>
  </div>

  <!-- MODAL: Enviar a inventario -->
  <div class="modal fade" id="modalInv" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">AÃ±adir al inventario</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formInv" class="row g-2 needs-validation" novalidate>
          <input type="hidden" id="invSku">
          <div class="col-12">
            <div class="form-text mb-1">Se crearÃ¡/actualizarÃ¡ el item en Inventario con este SKU.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Stock inicial</label>
            <input id="invStock" type="number" min="0" class="form-control" value="0" required>
            <div class="invalid-feedback">Stock â‰¥ 0.</div>
          </div>
          <div class="col-6">
            <label class="form-label">Stock mÃ­nimo</label>
            <input id="invMin" type="number" min="0" class="form-control" value="0" required>
            <div class="invalid-feedback">MÃ­nimo â‰¥ 0.</div>
          </div>
          <div class="col-12">
            <label class="form-label">Vence (opcional)</label>
            <input id="invVence" type="date" class="form-control">
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-warning">Aplicar</button>
          </div>
        </form>
      </div>
    </div></div>
  </div>

  <!-- MODAL: Confirmar eliminaciÃ³n -->
<div class="modal fade" id="modalDel" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Eliminar producto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Â¿EstÃ¡s seguro de eliminar el producto <strong id="delSkuTxt"></strong>?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-danger" id="btnDeleteConfirm">Eliminar</button>
      </div>
    </div>
  </div>
</div>


  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script src="/js/auth.js" defer></script>
  <script src="/js/api.js"  defer></script>

  <script defer>
  (() => {
    'use strict';

    const $   = (id) => document.getElementById(id);
    const PEN = new Intl.NumberFormat('es-PE',{ style:'currency', currency:'PEN' });
    const fmt = (n) => PEN.format(Number(n||0));

    /* ======================== Helpers de red ======================== */
    function authHeaders() {
      const h = (window.Auth && typeof Auth.authHeader === 'function') ? Auth.authHeader() : {};
      return { 'Content-Type':'application/json', ...h };
    }

    function isAuthError(res){ return res.status === 401 || res.status === 403; }
    window.fetchJSON = fetchJSON;
    async function fetchJSON(url, opts = {}) {
      const r = await fetch(url, { headers: authHeaders(), ...opts });
      if (isAuthError(r)) {
        alert('SesiÃ³n expirada o sin permisos. Vuelve a iniciar sesiÃ³n.');
        if (window.Auth?.clear) Auth.clear();
        location.href = 'index.html';
        throw new Error('unauthorized');
      }
      if (!r.ok) {
        const msg = (await r.text().catch(()=>'')) || r.statusText;
        throw new Error(msg);
      }
      if (r.status === 204) return null;
      return r.json();
    }
    window.fetchJSON = fetchJSON;

    /* ======================== API Productos ======================== */
    async function apiListProductos() {
      if (window.API?.productos?.list) return API.productos.list();
      return fetchJSON('/api/productos');
    }

    async function apiToggleActivo(sku, value) {
      if (window.API?.productos?.toggle) return API.productos.toggle(sku, value);
      return fetchJSON(`/api/productos/${encodeURIComponent(sku)}/activo`, {
        method:'PUT',
        body: JSON.stringify({ activo: !!value })
      });
    }

    async function apiGuardarProducto(payload, editSku) {
      const url    = editSku ? `/api/productos/${encodeURIComponent(editSku)}` : '/api/productos';
      const method = editSku ? 'PUT' : 'POST';
      return fetchJSON(url, { method, body: JSON.stringify(payload) });
    }

    /* ======================== NormalizaciÃ³n y estado ======================== */
    function norm(p){
      return {
        sku:        p.sku ?? p.SKU ?? p.codigo ?? p.code ?? '',
        nombre:     p.nombre ?? p.name ?? p.producto ?? '',
        barras:     p.codigoBarras ?? p.barras ?? p.barcode ?? p.codigo_barras ?? '',
        categoria:  p.categoria ?? p.category ?? '',
        proveedor:  p.proveedorNombre ?? p.proveedor ?? p.vendor ?? '',
        precio:     Number(p.precio ?? p.price ?? 0),
        costo:      Number(p.costo ?? p.cost ?? 0),
        activo:     ('activo' in p) ? (p.activo===true || p.activo==='true' || p.activo===1) : true
      };
    }

    function margenPct(p){
      if (!p || !(p.precio>0)) return 0;
      return (1 - (Number(p.costo||0) / Number(p.precio))) * 100;
    }

    let DATA = [];
    let modalProd = null;

    /* ======================== Render KPIs/Tabla ======================== */
    function renderKPIs(list){
      const tot  = list.length;
      const act  = list.filter(p => p.activo).length;
      const cat  = new Set(list.map(p => p.categoria).filter(Boolean)).size;
      const precios = list.map(p=>p.precio).filter(v => Number.isFinite(v) && v>0);
      const prom = precios.length ? precios.reduce((a,b)=>a+b,0) / precios.length : 0;

      $('kpiTot').textContent  = tot;
      $('kpiAct').textContent  = act;
      $('kpiCat').textContent  = cat;
      $('kpiProm').textContent = fmt(prom);
    }

    function fillFilters(list){
      const selCat = $('filtroCat');
      const cats = Array.from(new Set(list.map(p=>p.categoria).filter(Boolean))).sort();
      selCat.innerHTML = '<option value="">Categorias</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');

      const selProv = $('filtroProv');
      const provs = Array.from(new Set(list.map(p=>p.proveedor).filter(Boolean))).sort();
      selProv.innerHTML = '<option value="">Proveedores</option>' + provs.map(c=>`<option value="${c}">${c}</option>`).join('');

      // tambiÃ©n llenamos los datalist del modal
      const dlCat  = $('dlCat');
      const dlProv = $('dlProv');
      if (dlCat)  dlCat.innerHTML  = cats.map(c=>`<option value="${c}">`).join('');
      if (dlProv) dlProv.innerHTML = provs.map(p=>`<option value="${p}">`).join('');
    }

    function applyFilters(){
      const txt  = ($('filtroTxt').value || '').trim().toLowerCase();
      const cat  = $('filtroCat').value || '';
      const prov = $('filtroProv').value || '';
      const est  = $('filtroEstado').value || '';
      const ord  = $('filtroOrden').value || 'nombreAsc';

      let arr = DATA.filter(p => {
        let ok = true;
        if (txt)  ok = ok && (
          (p.sku||'').toLowerCase().includes(txt) ||
          (p.nombre||'').toLowerCase().includes(txt) ||
          (p.barras||'').toLowerCase().includes(txt)
        );
        if (cat)  ok = ok && p.categoria === cat;
        if (prov) ok = ok && p.proveedor === prov;
        if (est === 'act') ok = ok && p.activo;
        if (est === 'ina') ok = ok && !p.activo;
        return ok;
      });

      switch (ord) {
        case 'precioDesc':
          arr.sort((a,b)=> (b.precio||0) - (a.precio||0));
          break;
        case 'margenDesc':
          arr.sort((a,b)=> margenPct(b) - margenPct(a));
          break;
        default:
          arr.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
      }

      renderTabla(arr);
    }

    function renderTabla(list){
      const tbody = $('prodBody');
      tbody.innerHTML = '';

      if(!list.length){
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Sin datos</td></tr>';
        return;
      }

      for (const p of list){
        const m = margenPct(p);
        const badge = p.activo ? 'success' : 'secondary';
        const est   = p.activo ? 'Activo'  : 'Inactivo';

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${p.sku}</td>
            <td>${p.nombre || '-'}</td>
            <td>${p.barras || '-'}</td>
            <td>${p.categoria || '-'}</td>
            <td>${p.proveedor || '-'}</td>
            <td class="text-end">${Number.isFinite(p.precio) ? fmt(p.precio) : '-'}</td>
            <td class="text-end">${Number.isFinite(p.costo)  ? fmt(p.costo)  : '-'}</td>
            <td class="text-end">${(Number.isFinite(m) ? Math.round(m*10)/10 : 0).toFixed(1)}%</td>
            <td><span class="badge bg-${badge}">${est}</span></td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary"
                        onclick="openProd('${p.sku}')">Editar</button>
                <button class="btn ${p.activo?'btn-outline-secondary':'btn-outline-success'}"
                        onclick="pageToggleActivo('${p.sku}', ${!p.activo})">
                  ${p.activo?'Desactivar':'Activar'}
                </button> 
    </button>
              </div>
            </td>
          </tr>
        `);
      }
    }

    /* ======================== Acciones globales (CRUD) ======================== */
    window.pageToggleActivo = async (sku, value) => {
      try { await apiToggleActivo(sku, value); await init(); }
      catch (e) { alert('Error al actualizar estado: ' + (e.message||e)); }
    };

    // abrir modal en modo nuevo o editar
    window.openProd = (sku) => {
      const form = $('formProd');
      if (!form) return;

      form.reset();
      form.classList.remove('was-validated');

      if (sku) {
        const p = DATA.find(x => x.sku === sku);
        $('titleProd').textContent = 'Editar producto';
        $('editSku').value = sku;
        if (p) {
          $('pSku').value     = p.sku;
          $('pBar').value     = p.barras || '';
          $('pNom').value     = p.nombre || '';
          $('pCat').value     = p.categoria || '';
          $('pProv').value    = p.proveedor || '';
          $('pPrecio').value  = p.precio ?? 0;
          $('pCosto').value   = p.costo ?? 0;
          $('pUnidad').value  = ''; // si tu entidad tiene campo unidad, aquÃ­ lo mapeas
          $('pActivo').value  = p.activo ? 'true' : 'false';
        }
      } else {
        $('titleProd').textContent = 'Nuevo producto';
        $('editSku').value = '';
        $('pActivo').value = 'true';
      }

      if (modalProd) modalProd.show();
    };

    /* ======================== Init & eventos ======================== */
    function setupFilters(){
      ['filtroTxt','filtroCat','filtroProv','filtroEstado','filtroOrden'].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.addEventListener('input', applyFilters);
        el.addEventListener('change', applyFilters);
      });
    }

    function setupForm(){
      const form = $('formProd');
      if (!form) return;

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        form.classList.add('was-validated');
        if (!form.checkValidity()) return;

        const editSku = $('editSku').value || null;

        const payload = {
          sku:             $('pSku').value.trim(),
          codigoBarras:    $('pBar').value.trim() || null,
          nombre:          $('pNom').value.trim(),
          categoria:       $('pCat').value.trim(),
          proveedorNombre: $('pProv').value.trim(),
          precio:          Number($('pPrecio').value || 0),
          costo:           Number($('pCosto').value || 0),
          unidad:          $('pUnidad').value.trim() || null,
          activo:          $('pActivo').value === 'true'
        };

        try{
          await apiGuardarProducto(payload, editSku);
          await init();

          if (modalProd) modalProd.hide();

          form.reset();
          form.classList.remove('was-validated');
          $('editSku').value = '';
        }catch(e){
          alert('Error al guardar producto: ' + (e.message || e));
        }
      });
    }

    async function init(){
      try{
        const raw = await apiListProductos();
        const arr = Array.isArray(raw) ? raw
                  : Array.isArray(raw?.content) ? raw.content
                  : Array.isArray(raw?.items)   ? raw.items
                  : Array.isArray(raw?.data)    ? raw.data
                  : [];
        DATA = arr.map(norm);
        renderKPIs(DATA);
        fillFilters(DATA);
        applyFilters();
      }catch(e){
        console.error('Carga productos:', e);
        $('prodBody').innerHTML = `<tr><td colspan="10" class="text-danger">Error: ${e.message||e}</td></tr>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (window.bootstrap && $('modalProd')) {
        modalProd = new bootstrap.Modal($('modalProd'));
      }
      setupFilters();
      setupForm();
      init();
    });

  })();

  let modalDel = null;
let deleteSku = null;

async function apiEliminarProducto(sku) {
  return fetchJSON(`/api/productos/${encodeURIComponent(sku)}`, {
    method: "DELETE"
  });
}

window.openDelete = (sku) => {
  deleteSku = sku;
  $('delSkuTxt').textContent = sku;
  modalDel.show();
};

document.addEventListener("DOMContentLoaded", () => {
  if (window.bootstrap && $('modalDel')) {
    modalDel = new bootstrap.Modal($('modalDel'));
  }

  $('btnDeleteConfirm').addEventListener('click', async () => {
    try {
      await apiEliminarProducto(deleteSku);
      modalDel.hide();
      await init(); // recargar tabla
    } catch (e) {
      alert("Error al eliminar: " + (e.message || e));
    }
  });
});

  </script>
</body>
</html>
